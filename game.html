<!doctype html>
<html lang="en">
<head>
    <title>This is my final project Game</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>
<body>
<div id = 'container' style = 'position : relative'>
    <div style = 'position:absolute; top:0; left:0; z-index: 2;'>
        <canvas id = 'backgroundCan' width = 500, heigth = 400></canvas>
    </div>
    <div style = 'position:absolute; top:0; left:0; z-index: 1;'>
    <script type="text/javascript" id = 'TheGame'>
        
        var config = {
            type: Phaser.AUTO,
            width: 320,
            height: 240,
            transparent: true,
            physics:{
                default: 'arcade',
                arcade:{
                    gravity: {y: 300},
                    debug: false
                }
            },
            scene: {
                preload: preload,  
                create: create,
                update: update
            }
        };

        var player;
        var ground;
        var score = 0;
        var scoreText = 0;
        var cursors;


        function preload()
        {
            this.load.image('ground', 'assets/ground.png');
            this.load.image('guy', 'assets/theGameBoy.png');
            this.load.image('obsticle', 'assets/obsticle.png');
            
        }

        var game = new Phaser.Game(config);

        function create()
        {
            //Ground
            ground = this.physics.add.staticGroup();
            ground.create(200, 230, 'ground').setScale(4).refreshBody(); 

            //Player
            player = this.physics.add.sprite(50, 200, 'guy');
            player.setCollideWorldBounds(true);

            //Obsticles
            obsticle = this.physics.add.group();
            obsticle.create(150, 200, 'obsticle');

            //Score
            scoreText = this.add.text(10,10, 'Score: 0', {fontSize: '16px', fill: '#000' } );
            
            cursors = this.input.keyboard.createCursorKeys();
            
            this.physics.add.collider(player, ground);
            this.physics.add.collider(obsticle, ground);

            this.physics.add.overlap(player, obsticle, gameOver, null, this);

        }

        function update()
        {


            if(cursors.left.isDown)
            {
                player.setVelocityX(-85);
            }
            else if(cursors.right.isDown)
            {
                player.setVelocityX(85);
            }
            else
            {
                player.setVelocityX(0);
            }

            if (cursors.up.isDown && player.body.touching.down)
            {
                player.setVelocityY(-200);
            }

            this.moveObs(this.obsticle, 2)

            if(obstilce.x < 0)
            {
                this.resetObs(obsticle);
            }
        }

        function gameOver()
        {
            var lblLoss = document.getElementById("loss");
            lblLoss.innerHTML = "^^  LOSER  ^^"
            startFunction();
        }

        function moveObs(obsticle, speed)
        {
            obsticle.x -= speed;
        }

        function resetObs(obsticle)
        {
            obsticle.x = 320;
            var randomSpeed = Phaser.Math.Between(1,3);
        }
    
    </script>
    </div>
    </div>

    <script>
    var canvas = document.getElementById('backgroundCan');
    var videoTrack;

    function startFunction()
    {
        const constraints = {"video": { width: { max: 400 } } };
        navigator.mediaDevices.getUserMedia(constraints)
            .then(gotMedia)
            .catch(e => {console.error('getUserMedia() failed: ', e); });
    }

    function gotMedia(mediaStream)
    {
        videoTrack = mediaStream.getVideoTracks()[0];
        var imageCapture = new ImageCapture(videoTrack);
        imageCapture.grabFrame()
            .then(processFrame)
            .catch(e => console.error('grabFrame() failed: ' + e));
    }

    function processFrame(imageBitmap)
    {
        canvas.width = imageBitmap.width;
        canvas.height = imageBitmap.height;
        canvas.getContext('2d').drawImage(imageBitmap, 0, 0);

        videoTrack.stop();
    }


    </script>

    <div style = 'position:absolute; bottom:0; left:0;'>
        <lable id = 'loss' style = 'font-size: 32px; color:red'></lable>
    </div>
    
</body>
</html> 